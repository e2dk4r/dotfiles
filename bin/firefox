#!/bin/sh
ProfileDir="$XDG_RUNTIME_DIR/firefox"
archive="$HOME/.mozilla/profile.tar.zst"

RestoreProfile=0
BackupProfile=0
for i in "$@"; do
  case $i in
    -s|--save|--backup)
      BackupProfile=1
    ;;
    -l|--load|--restore)
      RestoreProfile=1
    ;;
    -h|--help|-?)
      cat <<EOF
firefox [options]

OPTIONS:
  -s, --save, --backup
    backup profile and exit

  -l, --load, --restore
    restore profile
EOF
    ;;
  esac
done

if [ $BackupProfile -eq 1 ]; then
  ProfileDirParent="${ProfileDir%/*}"
  ProfileDirBasename="${ProfileDir##*/}"

  tmpfile="$(mktemp)"
  tar cf "$tmpfile"                  \
    -C "$ProfileDirParent"           \
    --exclude adb/                   \
    --exclude storage/               \
    --exclude startupCache/          \
    --exclude cache2/                \
    --exclude gmp-gmpopenh264/       \
    --exclude datareporting/         \
    --exclude saved-telemetry-pings/ \
    --exclude safebrowsing/          \
    --exclude security_state/        \
    --exclude bookmarkbackups/       \
    --exclude sessionstore-backups/  \
    --exclude sessionstore-logs/     \
    --exclude thumbnails/            \
    --exclude weave/                 \
    --exclude favicons.sqlite        \
    --exclude favicons.sqlite-shm    \
    --exclude favicons.sqlite-wal    \
    "$ProfileDirBasename"

  userContextId=$(jq '.identities.[] | select(.name == "userContextIdInternal.webextStorageLocal") | .userContextId' "$ProfileDir/containers.json")
  # Some extensions store their data in storage-sync-v2.sqlite some in storage/default/moz-extension+++$uuid
  uuids=$(cat "$ProfileDir/prefs.js" | grep extensions.webextensions.uuids | cut -d ',' -f2- | sed 's/");$//' | sed 's/^ "//' | sed 's/\\"/"/g')
  ublock0=$(echo "$uuids" | jq -r '."uBlock0@raymondhill.net"')
  redirector=$(echo "$uuids" | jq -r '."redirector@einaregilsson.com"')

  tar rf "$tmpfile"                                                                                                         \
    -C "$ProfileDirParent"                                                                                                  \
    "$ProfileDirBasename/storage/default/moz-extension+++$ublock0"                              \
    "$ProfileDirBasename/storage/default/moz-extension+++$ublock0^userContextId=$userContextId" \
    "$ProfileDirBasename/storage/default/moz-extension+++$redirector^userContextId=$userContextId"

  tmpArchive="$(mktemp)"
  zstd -3fo "$tmpArchive" "$tmpfile"
  cp "$tmpArchive" "$archive"
  rm "$tmpfile" "$tmpArchive"
  echo Backup firefox profile
  exit 0
fi

if [ $RestoreProfile -eq 1 ] || [ ! -d "$ProfileDir" ]; then
  ProfileDirParent="${ProfileDir%/*}"
  tar xf "$archive" -C "$ProfileDirParent"
  echo Loaded firefox profile
fi

# pipewire v4l2
export LD_PRELOAD='/usr/lib64/pipewire-0.3/v4l2/libpw-v4l2.so'

export MOZ_ALLOW_DOWNGRADE=1
export MOZ_APP_LAUNCHER=/usr/lib64/firefox/firefox
export MOZ_ENABLE_WAYLAND=1
export MOZ_USE_XINPUT2=1
exec $MOZ_APP_LAUNCHER --profile "$ProfileDir" "$@"
